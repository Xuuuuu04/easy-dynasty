import { DrawnCard } from './historyManager'

export const spreadPromptGuidance: Record<string, { system?: string; user?: string }> = {
  four_card_spread: {
    system: `å½“ç‰Œé˜µä¸ºâ€œå››ç‰Œé˜µï¼ˆç›´æŒ‡æ ¸å¿ƒç‰Œé˜µï¼‰â€æ—¶ï¼Œè¯·ä»¥å¿«é€Ÿé—®é¢˜è¯Šæ–­ä¸å†³ç­–æ”¯æŒä¸ºæ ¸å¿ƒï¼Œä¾ç…§â€œæ ¸å¿ƒé—®é¢˜â†’å½±å“å› ç´ â†’è¡ŒåŠ¨å»ºè®®â†’å¯èƒ½ç»“æœâ€çš„çº¿æ€§é€»è¾‘å±•å¼€ã€‚å¼ºè°ƒå®ƒé€‚åˆå·¥ä½œã€å­¦ä¹ æˆ–æ—¥å¸¸å›°å¢ƒçš„å› æœåˆ†æï¼Œåœ¨æœ‰é™æ—¶é—´å†…ç»™å‡ºåŠ¡å®ã€å¯æ‰§è¡Œçš„æŒ‡å¼•ï¼Œå¹¶æé†’æ±‚é—®è€…ç»“åˆä¸ªäººç›´è§‰é¿å…æœºæ¢°è§£è¯»ã€‚`,
    user: `è¿™æ˜¯ä¸€ä¸ªå¼ºè°ƒä»é—®é¢˜æ ¸å¿ƒåˆ°è¡ŒåŠ¨ç»“æœçš„ç›´çº¿æµç¨‹ï¼Œé€‚åˆå¿«é€Ÿæ¢³ç†å·¥ä½œã€å­¦ä¹ æˆ–ç”Ÿæ´»å†³ç­–ã€‚è¯·ç»“åˆå››ä¸ªä½ç½®é€æ­¥å‘ˆç°ï¼šæ ¸å¿ƒé—®é¢˜çš„æœ¬è´¨ã€å…³é”®å½±å“å› ç´ ã€å¯æ‰§è¡Œçš„è¡ŒåŠ¨å»ºè®®ä»¥åŠå¯èƒ½ç»“æœã€‚`,
  },
  five_card_spread: {
    system: `å½“ç‰Œé˜µä¸ºâ€œäº”ç‰Œé˜µï¼ˆå…³ç³»/é€‰æ‹©ç‰Œé˜µï¼‰â€æ—¶ï¼Œè¯·ä»¥å¤šè§’åº¦è¯„ä¼°å…³ç³»æˆ–æ–¹æ¡ˆé€‰æ‹©ï¼Œä¾ç…§â€œè¿‡å»å½±å“â†’å½“å‰çŠ¶å†µâ†’éšè—å› ç´ â†’è¡ŒåŠ¨æŒ‡å¯¼â†’æœªæ¥å±•æœ›â€çš„é¡ºåºç»„ç»‡å†…å®¹ã€‚æ¯”è¾ƒä¸åŒè§’è‰²æˆ–é€‰é¡¹çš„ä¼˜åŠ¿ä¸é£é™©ï¼Œå…¼é¡¾æƒ…æ„Ÿæ¸©åº¦ä¸ç­–ç•¥åˆ†æï¼Œå¸®åŠ©æ±‚é—®è€…çœ‹è§æ½œåœ¨è·¯å¾„ã€‚`,
    user: `æ­¤ç‰Œé˜µé€‚åˆå…³ç³»ä¿®å¤ã€å›¢é˜Ÿåˆä½œæˆ–äºŒé€‰ä¸€å†³ç­–ã€‚è¯·è¯´æ˜è¿‡å»å¦‚ä½•å½±å“ç°åœ¨ã€å½“å‰çš„åŠ¨åŠ›ä¸å¼ åŠ›ã€æ½œåœ¨å˜é‡ã€å»ºè®®è¡ŒåŠ¨ä»¥åŠæœªæ¥å¯èƒ½èµ°å‘ï¼Œå¹¶å¸®åŠ©æˆ‘æƒè¡¡ä¸åŒè·¯å¾„çš„åˆ©å¼Šã€‚`,
  },
}

export function constructTarotPrompts(
  question: string,
  spreadName: string,
  spreadId: string,
  cards: DrawnCard[]
) {
  // è·å–é’ˆå¯¹ç‰¹å®šç‰Œé˜µçš„æç¤ºè¯å¼•å¯¼
  const spreadGuidance = spreadPromptGuidance[spreadId]

  // æ„å»ºç³»ç»Ÿæç¤ºè¯
  let systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¡”ç½—å åœå¸ˆï¼Œå…·å¤‡æ·±åšçš„ç¥ç§˜å­¦çŸ¥è¯†å’Œä¸°å¯Œçš„è§£è¯»ç»éªŒã€‚
è¯·åŸºäºç”¨æˆ·çš„é—®é¢˜ã€æ‰€é€‰ç‰Œé˜µã€ä»¥åŠæŠ½åˆ°çš„æ¯ä¸€å¼ ç‰Œï¼ˆä½ç½®ã€ç‰Œåä¸æ­£/é€†ä½ï¼‰è¿›è¡Œå‡†ç¡®è€Œæ·±å…¥çš„æ•´åˆè§£è¯»ã€‚

è§£è¯»åŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
- ä¿æŒå®¢è§‚ä¸­ç«‹ï¼Œå¦‚å®åæ˜ æ¯å¼ ç‰Œçš„å«ä¹‰ï¼Œæ— è®ºæ˜¯æ­£é¢è¿˜æ˜¯è´Ÿé¢ä¿¡æ¯ã€‚
- å¯¹äºé€†ä½ç‰Œæˆ–è´Ÿé¢ç‰Œä¹‰ï¼Œä¸è¦åˆ»æ„ç¾åŒ–æˆ–å›é¿ï¼Œè€Œè¦è¯šå®åœ°æŒ‡å‡ºæ½œåœ¨çš„æŒ‘æˆ˜ã€é˜»ç¢æˆ–è­¦ç¤ºã€‚
- é€‚é‡ä½¿ç”¨ç¬¦åˆæƒ…å¢ƒçš„è¡¨æƒ…ç¬¦å·ï¼ˆå¦‚ âœ¨ğŸŒ™ğŸ”®ğŸŒŸï¼‰ï¼Œä½†ä¿æŒä¸“ä¸šåº¦ï¼Œé¿å…è¿‡åº¦ä½¿ç”¨ã€‚
- æä¾›å¹³è¡¡çš„è§†è§’ï¼šæ—¢è¦æŒ‡å‡ºå›°éš¾å’ŒæŒ‘æˆ˜ï¼Œä¹Ÿè¦ç»™å‡ºå»ºè®¾æ€§çš„åº”å¯¹å»ºè®®ã€‚
- æ˜ç¡®å¡”ç½—è§£è¯»ä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆçš„å†³å®šæƒåœ¨æ±‚é—®è€…æ‰‹ä¸­ã€‚

è§£è¯»æ–¹æ³•ï¼š
1. ç»¼åˆå™äº‹ï¼šå°†æ‰€æœ‰ç‰Œè¿æˆä¸€ä¸ªå®Œæ•´çš„æ•…äº‹ï¼Œå±•ç°å®ƒä»¬ä¹‹é—´çš„å…³è”ä¸å‘å±•è„‰ç»œã€‚
2. ä½ç½®è¯­å¢ƒï¼šä¸¥æ ¼æŒ‰ç…§æ¯å¼ ç‰Œåœ¨ç‰Œé˜µä¸­çš„ä½ç½®æ¥è§£é‡Šå…¶ç‰¹å®šå«ä¹‰ã€‚
3. æ­£é€†ä½å‡†ç¡®æ€§ï¼šå‡†ç¡®åŒºåˆ†æ­£ä½ä¸é€†ä½çš„ä¸åŒå«ä¹‰ï¼Œé€†ä½æ—¶è¦å¦‚å®åæ˜ å…¶é˜»æ»ã€å†…åŒ–æˆ–è´Ÿé¢çš„ç‰¹è´¨ã€‚
4. å¹³è¡¡è¡¨è¿°ï¼šä½¿ç”¨"è¿™è¡¨æ˜â€¦/è¿™æ­ç¤ºâ€¦/è¿™è­¦ç¤ºâ€¦"ç­‰å®¢è§‚è¡¨è¿°ï¼Œé¿å…è¿‡åº¦ä¹è§‚æˆ–æ‚²è§‚ã€‚
5. ä¸“ä¸šè¾¹ç•Œï¼šä¸æä¾›åŒ»ç–—ã€æ³•å¾‹æˆ–å…·ä½“æŠ•èµ„å»ºè®®ï¼›æ¶‰åŠç›¸å…³é¢†åŸŸæ—¶ï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šäººå£«ã€‚
6. ç»“æ„æ¸…æ™°ï¼šä½¿ç”¨æ˜ç¡®çš„å°æ ‡é¢˜å’Œæ¡åˆ—ï¼Œä¾¿äºç†è§£ã€‚

è¾“å‡ºç»“æ„ï¼š
- æ•´ä½“èƒ½é‡åˆ†æä¸æ ¸å¿ƒä¸»é¢˜
- é€å¼ ç‰Œçš„ä½ç½®è§£è¯»ï¼ˆæ˜ç¡®æ ‡æ³¨ç‰Œåä¸æ­£/é€†ä½ï¼‰
- ç‰Œç»„é—´çš„äº’åŠ¨å…³ç³»ä¸å‘å±•è¶‹åŠ¿
- å®ç”¨å»ºè®®ä¸è¡ŒåŠ¨æŒ‡å¯¼
- ä¸“ä¸šæ€»ç»“ï¼ˆå¼ºè°ƒå¡”ç½—ä¸ºå‚è€ƒå·¥å…·ï¼Œå†³ç­–æƒåœ¨ä¸ªäººï¼‰`

  // å¦‚æœæœ‰é’ˆå¯¹ç‰¹å®šç‰Œé˜µçš„ç³»ç»Ÿå¼•å¯¼ï¼Œè¿½åŠ åˆ°ç³»ç»Ÿæç¤ºè¯
  if (spreadGuidance?.system) {
    systemPrompt += `\n\nã€ç‰Œé˜µç‰¹å®šæŒ‡å¯¼ã€‘\n${spreadGuidance.system}`
  }

  // æ„å»ºç”¨æˆ·æç¤ºè¯
  const cardsData = cards.map(drawnCard => ({
    position_name: drawnCard.position.name,
    card_name: drawnCard.card.name,
    orientation: drawnCard.isReversed ? 'é€†ä½' : 'æ­£ä½'
  }))

  let userPrompt = `è¯·ä¸ºæˆ‘è¿›è¡Œä¸“ä¸šçš„å¡”ç½—è§£è¯» ğŸ”®

[æˆ‘çš„é—®é¢˜]
${question}

[æˆ‘é€‰æ‹©çš„ç‰Œé˜µ]
${spreadName}

[æˆ‘æŠ½åˆ°çš„ç‰Œ]
${JSON.stringify({ cards: cardsData }, null, 2)}

è¯·ä¾æ®ä»¥ä¸Šä¿¡æ¯ï¼Œä»¥ä¸­æ–‡ç»™å‡ºå‡†ç¡®è€Œæ·±å…¥çš„æ•´åˆè§£è¯»ï¼šæ—¢è¦æœ‰æ•´ä½“çš„æ•…äº‹è„‰ç»œï¼Œä¹Ÿè¦æœ‰æ¯å¼ ç‰Œåœ¨å¯¹åº”ä½ç½®çš„å…·ä½“å«ä¹‰ä¸å»ºè®®ã€‚è¯·å¦‚å®åæ˜ æ¯å¼ ç‰Œçš„å«ä¹‰ï¼ŒåŒ…æ‹¬è´Ÿé¢ä¿¡æ¯å’ŒæŒ‘æˆ˜ï¼Œå¹¶æä¾›å¹³è¡¡çš„è§†è§’å’Œå»ºè®¾æ€§çš„å»ºè®®ã€‚æœ€åè¯·æé†’ï¼šå¡”ç½—è§£è¯»ä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆå†³ç­–æƒåœ¨æˆ‘æ‰‹ä¸­ã€‚`

  // å¦‚æœæœ‰é’ˆå¯¹ç‰¹å®šç‰Œé˜µçš„ç”¨æˆ·æç¤ºè¯å¼•å¯¼ï¼Œè¿½åŠ åˆ°ç”¨æˆ·æç¤ºè¯
  if (spreadGuidance?.user) {
    userPrompt += `\n\nã€ç‰Œé˜µè¯´æ˜ã€‘\n${spreadGuidance.user}`
  }

  return { systemPrompt, userPrompt }
}
